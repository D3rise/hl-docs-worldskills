# Деплой чейнкода (смарт-контракта) в блокчейн-сеть HyperLedger Fabric

*На примере чейнкода на JavaScript из `fabric-samples` (`fabric-samples/asset-transfer-basic/chaincode-javascript`)*  
В примере папка `fabric-samples` находится в `~`.  

В сети два компьютера, четыре организации: 0 для Orderer, 1
для Users, 2 для Shops и 3 для Bank.  
Адрес первого и второго компьютеров соответственно: `192.168.21.60` и `192.168.21.61`.  
Порты пиров организаций: `9051-9053` для организаций 1-3 соответственно, `7050` для организации 0 (orderer).

* Установка смарт-контракта делится на четыре стадии: упаковка (`package`), установка (`install`), подтверждение (`approve`) и фиксирование (`commit`)

1. Скопировать папку с чейнкодом в общую папку всех организаций (`orgs/common`):  
   `cp -r ~/fabric-samples/asset-transfer-basic/chaincode-javascript ./orgs/common/chaincode`

2. Упаковка (package) чейнкода в архив:
   1. Предположим, что папку с чейнкодом мы скопировали на первой машине в сети (на которой запущена нулевая и первая организация)
   2. Упаковываем чейнкод в файл `cc.tar.gz` (сохранится в `./orgs/common`):  
   `docker exec cli-org1 peer lifecycle chaincode package --path /hl/common/chaincode --lang node --label basic cc.tar.gz`

3. Установка (install) смарт-контракта
   1. Установка должна производится во всех организациях в сети
   2. Поскольку организации у нас распределены по двух машинам, нам будет необходимо перенести созданный `./orgs/common/cc.tar.gz` на вторую машину в сети
   3. Для установки смарт-контракта на первой машине в первой организации:  
   `docker exec cli-org1 peer lifecycle chaincode install cc.tar.gz`  
   По аналогии, установка смарт-контракта на второй машине во второй организации:  
   `docker exec cli-org2 peer lifecycle chaincode install cc.tar.gz`
   4. После установки в выводе команды мы получим идентификатор смарт-контракта, состоящий из его названия и хеша (уникален для каждого смарт-контракта, отличающегося от других), например `basic_1.0:69de748301770f6ef64b42aa6bb6cb291df20aa39542c3ef94008615704007f3`. Сохраняем его, он понадобится при подтверждении смарт-контракта.
   5. В случае, если идентификатор смарт-контракта был утерян, мы можем посмотреть его с помощью команды `peer lifecycle chaincode queryinstalled`:  
   `docker exec cli-org1 peer lifecycle chaincode queryinstalled`

4. Подтверждение (approve) смарт-контракта
   1. Подтверждение, как и установка, должна производится во всех организациях в сети
   2. Мы подтверждаем каждый заливаемый в блокчейн смарт-контракт с помощью команды `peer lifecycle chaincode approveformyorg`
   3. Для подтверждения смарт-контракта на первой машине в первой организации:
   `docker exec cli-org1 peer lifecycle chaincode approveformyorg --orderer 192.168.21.60:7050 --channelID wsr --name basic --version 1.0 --sequence 1 --package-id basic_1.0:69de748301770f6ef64b42aa6bb6cb291df20aa39542c3ef94008615704007f3`, где:
      1. `channelID`: ID канала, в который отправляется смарт-контракт
      2. `name`: название смарт-контракта
      3. `version`: версия смарт-контракта
      4. `sequence`: порядковый номер смарт-контракта в канале (необходимо увеличивать на 1 при каждой отправке любых версий одного смарт-контракта в канал)
      5. `package-id`: идентификатор смарт-контракта, полученный при установке смарт-контракта
      6. `orderer`: адрес Orderer (см. Глоссарий в `configtx.yaml`)

5. Фиксирование или развёртка (commit) смарт-контракта
   1. Для развёртывания смарт-контракта необходимо запустить команду только на одной машине, принадлежащей к сети
   2. Команда развёртывания очень похожа на подтверждение смарт-контракта, но `package-id` больше не используется. Однако, нам нужно будет знать IP адреса и порты других организаций (например, если мы разворачиваем смарт-контракт с первого компьютера, нам нужно будет знать IP адрес второго компьютера в сети, а если со второго, то наоборот)
   3. Развёртывание с первого компьютера в сети:
   `docker exec cli-org1 peer lifecycle chaincode commit --orderer 192.168.21.60:7050 --channelID wsr --name basic --version 1.0 --sequence 1 --peerAddresses 192.168.21.61:9052 --peerAddresses 192.168.21.61:9053`, где:
      1. `orderer`, `channelID`, `name`, `version`, `sequence` - как и в подтверждении
      2. `peerAddresses` - IP адреса и порты пиров, которые должны подтвердить фиксирование смарт-контракта (по умолчанию: все пользовательские организации в сети, такие как Users, Shops, Bank)
